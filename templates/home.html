{% extends "base.html" %}
{% block title %}Dashboard | MCA{% endblock %}
{% block content %}

<h2 class="mb-3">Dashboard</h2>

<!-- KPIs -->
<div class="row g-3 mb-3">
  <div class="col-md-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="text-muted mb-1"><i class="fa-solid fa-money-bill-wave"></i> A receber (aberto)</div>
        <div class="fs-4 fw-bold">R$ {{ kpi_total_aberto|floatformat:2 }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="text-muted mb-1"><i class="fa-solid fa-clock-rotate-left"></i> Em atraso</div>
        <div class="fs-4 fw-bold text-danger">R$ {{ kpi_total_atrasado|floatformat:2 }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="text-muted mb-1"><i class="fa-solid fa-circle-check"></i> Recebido (mês)</div>
        <div class="fs-4 fw-bold text-success">R$ {{ kpi_recebido_mes|floatformat:2 }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="text-muted mb-1"><i class="fa-solid fa-person-chalkboard"></i> Turmas ativas</div>
        <div class="fs-4 fw-bold">{{ kpi_turmas_ativas }}</div>
        <div class="small text-muted">{{ kpi_matriculas_ativas }} matrículas ativas</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  <!-- Chart Receitas -->
  <div class="col-lg-7">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white">
        <strong>Faturamento (6 meses) — Previsto x Recebido x Aberto</strong>
      </div>
      <div class="card-body">
        <canvas id="chartReceitas" height="120"></canvas>
      </div>
    </div>
  </div>

  <!-- Chart Ocupação Turmas -->
  <div class="col-lg-5">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-white">
        <strong>Ocupação por Turma (Top 8)</strong>
      </div>
      <div class="card-body">
        <canvas id="chartTurmas" height="120"></canvas>
        {% if not chart_turmas_labels %}
          <div class="text-muted small mt-2">Sem dados de turmas.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Próximas aulas -->
<div class="card border-0 shadow-sm mt-3">
  <div class="card-header bg-white">
    <strong>Próximas aulas (7 dias)</strong>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Data</th>
            <th>Horário</th>
            <th>Turma</th>
            <th>Condomínio</th>
            <th>Professor</th>
            <th>Ocupação</th>
            <th style="width: 120px;"></th>
          </tr>
        </thead>
        <tbody>
          {% for a in proximas %}
          <tr>
            <td>{{ a.data|date:"d/m/Y (D)" }}</td>
            <td>{{ a.hora|time:"H:i" }}</td>
            <td>{{ a.titulo }}</td>
            <td>{{ a.condominio }}</td>
            <td>{{ a.professor }}</td>
            <td>
              {% if a.ocupacao >= a.capacidade %}
                <span class="badge text-bg-danger">{{ a.ocupacao }}/{{ a.capacidade }}</span>
              {% else %}
                <span class="badge text-bg-primary">{{ a.ocupacao }}/{{ a.capacidade }}</span>
              {% endif %}
            </td>
            <td>
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'turmas:alunos' a.turma_id %}">
                <i class="fa-solid fa-users"></i> Ver alunos
              </a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="text-center py-4 text-muted">Sem aulas nos próximos 7 dias.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Dados para os gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const monthLabels = {{ month_labels|safe }};
  const seriePrevisto = {{ serie_previsto|safe }};
  const serieRecebido = {{ serie_recebido|safe }};
  const serieAberto = {{ serie_aberto|safe }};

  const ctx1 = document.getElementById('chartReceitas').getContext('2d');
  new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: monthLabels,
      datasets: [
        { label: 'Previsto (vencimento)', data: seriePrevisto },
        { label: 'Recebido (liquidado)', data: serieRecebido },
        { label: 'Aberto', data: serieAberto },
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' } },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  const turmasLabels = {{ chart_turmas_labels|safe }};
  const turmasOcc = {{ chart_turmas_occ|safe }};
  const turmasCap = {{ chart_turmas_cap|safe }};
  const ctx2 = document.getElementById('chartTurmas').getContext('2d');
  new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: turmasLabels,
      datasets: [
        { label: 'Matriculados', data: turmasOcc },
        { label: 'Capacidade', data: turmasCap },
      ]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: { legend: { position: 'bottom' } },
      scales: {
        x: { beginAtZero: true }
      }
    }
  });
</script>

{% endblock %}
