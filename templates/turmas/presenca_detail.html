{% extends "base.html" %}
{% block title %}Presença — {{ lista.turma.modalidade.nome }} | MCA{% endblock %}
{% block content %}

{% if messages %}
  <div class="mb-3">{% for message in messages %}<div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>{% endfor %}</div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="mb-1">Lista de Presença — {{ lista.data|date:"d/m/Y" }}</h4>
    <div class="text-muted">
      {{ lista.turma.modalidade.nome }} — {{ lista.turma.condominio.nome }} · Professor: <strong>{{ lista.turma.professor.nome }}</strong>
      · {{ lista.turma.get_dia_semana_display }} {{ lista.turma.hora_inicio|time:"H:i" }}
    </div>
  </div>
  <a class="btn btn-outline-secondary" href="{% url 'turmas:presencas_turma' turma_id=lista.turma_id %}">
    <i class="fa-solid fa-arrow-left"></i> Voltar
  </a>
</div>

<div class="card mb-3">
  <div class="card-body">
    <form method="post" action="{% url 'turmas:presenca_salvar' lista.id %}" class="mb-2">
      {% csrf_token %}
      <div class="d-flex gap-2 mb-2">
        <button class="btn btn-outline-success" type="submit" name="action" value="mark_all" onclick="addHidden(this.form, 'value','1')">
          <i class="fa-solid fa-user-check"></i> Marcar todos
        </button>
        <button class="btn btn-outline-warning" type="submit" name="action" value="mark_all" onclick="addHidden(this.form, 'value','0')">
          <i class="fa-solid fa-user-xmark"></i> Desmarcar todos
        </button>
        <button class="btn btn-outline-dark" type="submit" name="action" value="sync">
          <i class="fa-solid fa-rotate"></i> Sincronizar com matrículas
        </button>
      </div>

      <div class="mb-3">
        <label class="form-label">Observação geral</label>
        <textarea class="form-control" name="observacao_geral" rows="2">{{ lista.observacao_geral }}</textarea>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 60px;">Pres.</th>
              <th>Aluno</th>
              <th>Documento</th>
              <th>Observação</th>
            </tr>
          </thead>
          <tbody>
            {% for it in itens %}
            <tr>
              <td>
                <input class="form-check-input" type="checkbox" name="presentes" value="{{ it.id }}" {% if it.presente %}checked{% endif %}>
              </td>
              <td>{{ it.cliente_nome_snapshot }}</td>
              <td>{{ it.cliente_doc_snapshot }}</td>
              <td>
                <input class="form-control" type="text" name="obs_{% templatetag openvariable %}it.id{% templatetag closevariable %}" value="{{ it.observacao|default_if_none:'' }}">
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-center py-4">Nenhum aluno nesta lista.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-end">
        <button class="btn btn-primary" type="submit" name="action" value="save">
          <i class="fa-solid fa-floppy-disk"></i> Salvar lista
        </button>
      </div>
    </form>
  </div>
</div>

<script>
function addHidden(form, name, value){
  var input = document.createElement('input');
  input.type = 'hidden';
  input.name = name;
  input.value = value;
  form.appendChild(input);
}
</script>

{% endblock %}
