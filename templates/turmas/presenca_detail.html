{% extends "base.html" %}
{% block title %}Presenças — {{ lista.turma }} | MCA{% endblock %}
{% block content %}

{% if messages %}
  <div class="mb-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

<div class="mb-3">
  <h5 class="mb-1">Lista de Presença</h5>
  <div class="text-muted small">
    {{ lista.turma.modalidade.nome }} — {{ lista.turma.condominio.nome }}
    • {{ lista.data|date:"d/m/Y" }} • {{ lista.turma.hora_inicio|time:"H:i" }}
  </div>
</div>

<form id="presencaForm" method="post" action="{% url 'turmas:presenca_salvar' lista.id %}">
  {% csrf_token %}

  <div class="card mb-3">
    <div class="card-header d-flex flex-wrap gap-2 align-items-center">
      <strong>Alunos matriculados ({{ matriculas.count }})</strong>
      <div class="ms-auto d-flex gap-2">
        <!-- Agora marcam/desmarcam os checkboxes no cliente -->
        <button type="button" class="btn btn-sm btn-outline-success" onclick="setAll(true)">Marcar todos</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setAll(false)">Desmarcar todos</button>
        <!-- Se ainda quiser revalidar no servidor, mantém o botão abaixo -->
        <button class="btn btn-sm btn-outline-primary" type="submit" name="action" value="sync">
          Revalidar matrículas do dia
        </button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:48px;" class="text-center">Pres.</th>
            <th>Aluno</th>
            <th class="d-none d-md-table-cell">Documento</th>
            <th class="d-none d-lg-table-cell">Cliente</th>
            <th style="width:28%;">Obs.</th>
          </tr>
        </thead>
        <tbody>
          {% for it in itens %}
  <tr>
    <td>
      <input type="checkbox" name="presentes" value="{{ it.id }}"
             {% if it.id in presente_ids %}checked{% endif %}>
    </td>
    <td>{{ it.cliente_nome_snapshot }}</td>
    <td>{{ it.cliente_doc_snapshot }}</td>
    <td>
      <input type="text" name="obs_I{{ it.id }}" class="form-control form-control-sm"
             value="{{ obs_por_item.it.id|default_if_none:'' }}">
    </td>
  </tr>
{% endfor %}

        </tbody>
      </table>
    </div>

    <div class="card-body border-top">
      <label class="form-label">Observação geral</label>
      <textarea name="observacao_geral" rows="2" class="form-control"
                placeholder="Ex.: Aula compartilhada; manutenção no espaço; etc.">{{ lista.observacao_geral }}</textarea>
    </div>

    <div class="card-footer d-flex justify-content-end gap-2">
      <a href="{% url 'turmas:presencas_turma' lista.turma.id %}" class="btn btn-secondary">Voltar</a>
      <button class="btn btn-success" type="submit" name="action" value="save">Salvar lista</button>
    </div>
  </div>
</form>

<script>
  function setAll(checked) {
    // marca/desmarca todos os checkboxes de presença visíveis no DOM
    document.querySelectorAll('input[name="presentes"]').forEach(cb => { cb.checked = checked; });
  }
</script>

{% endblock %}
