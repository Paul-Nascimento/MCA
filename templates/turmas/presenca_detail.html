{% extends "base.html" %}
{% block title %}Presenças — {{ lista.turma }} | MCA{% endblock %}
{% block content %}

{% if messages %}
  <div class="mb-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

<div class="mb-3">
  <h5 class="mb-1">Lista de Presença</h5>
  <div class="text-muted small">
    {{ lista.turma.modalidade.nome }} — {{ lista.turma.condominio.nome }}
    • {{ lista.data|date:"d/m/Y" }} • {{ lista.turma.hora_inicio|time:"H:i" }}
  </div>
</div>

<form id="presencaForm" method="post" action="{% url 'turmas:presenca_salvar' lista.id %}">
  {% csrf_token %}

  <!-- ✅ Cabeçalho de ocorrência da aula -->
  <div class="card border-success mb-3">
    <div class="card-body row align-items-center g-3">
      <div class="col-md-6">
        <label class="form-label fw-bold">Ocorrência da aula</label>
        <select name="ocorrencia_aula" id="ocorrencia_aula" class="form-select">
          <option value="NORMAL" {% if lista.ocorrencia_aula == "NORMAL" %}selected{% endif %}>Aula Normal</option>
          <option value="FALTA_PROF" {% if lista.ocorrencia_aula == "FALTA_PROF" %}selected{% endif %}>Falta do Professor</option>
          <option value="CANCELADA" {% if lista.ocorrencia_aula == "CANCELADA" %}selected{% endif %}>Aula Cancelada</option>
          <option value="SUBSTITUIDO" {% if lista.ocorrencia_aula == "SUBSTITUIDO" %}selected{% endif %}>Professor Substituído</option>
          <option value="REPOSICAO" {% if lista.ocorrencia_aula == "REPOSICAO" %}selected{% endif %}>Aula de Reposição</option>
        </select>
        <div class="form-text">Selecione o tipo de ocorrência. Apenas aulas “Normais” e “Reposição” permitem marcar presença de alunos.</div>
      </div>
    </div>
  </div>

  <!-- ✅ Tabela de alunos -->
  <div class="card mb-3">
    <div class="card-header d-flex flex-wrap gap-2 align-items-center">
      <strong>Alunos matriculados ({{ itens|length }})</strong>
      <div class="ms-auto d-flex gap-2">
        <button type="button" class="btn btn-sm btn-outline-success" onclick="setAll(true)">Marcar todos</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setAll(false)">Desmarcar todos</button>
        <button class="btn btn-sm btn-outline-primary" type="submit" name="action" value="sync">
          Revalidar matrículas
        </button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th style="width: 3rem;" class="text-center">Presença</th>
            <th>Cliente (titular)</th>
            <th>Aluno</th>
            <th>Observação</th>
          </tr>
        </thead>
        <tbody>
          {% for item in itens %}
            <tr>
              <td class="text-center align-middle">
                <input class="form-check-input aluno-checkbox"
                       type="checkbox"
                       name="presentes"
                       value="{{ item.id }}"
                       {% if item.id in presente_ids %}checked{% endif %}>
              </td>
              <td class="align-middle">{{ item.cliente.nome_razao }}</td>
              <td class="align-middle">{{ item.cliente_nome_snapshot }}</td>
              <td>
                <input type="text" class="form-control"
                       name="obs_I{{ item.id }}"
                       value="{{ item.observacao|default_if_none:'' }}">
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card-body border-top">
      <label class="form-label">Observação geral</label>
      <textarea name="observacao_geral" rows="2" class="form-control"
                placeholder="Ex.: Aula compartilhada; manutenção no espaço; etc.">{{ lista.observacao_geral }}</textarea>
    </div>

    <div class="card-footer d-flex justify-content-end gap-2">
      <a href="{% url 'turmas:presencas_turma' lista.turma.id %}" class="btn btn-secondary">Voltar</a>
      <button class="btn btn-success" type="submit" name="action" value="save">Salvar lista</button>
    </div>
  </div>
</form>

<script>
  // Marca/desmarca todos os checkboxes de presença
  function setAll(checked) {
    document.querySelectorAll('.aluno-checkbox:not(:disabled)').forEach(cb => { cb.checked = checked; });
  }

  // Desabilita checkboxes se a aula não permitir presença
  const ocorrenciaSelect = document.getElementById('ocorrencia_aula');
  const alunoCheckboxes = document.querySelectorAll('.aluno-checkbox');

  function toggleAlunoCheckboxes() {
    const tipo = ocorrenciaSelect.value;
    const podeMarcar = (tipo === "NORMAL" || tipo === "REPOSICAO");
    alunoCheckboxes.forEach(cb => cb.disabled = !podeMarcar);
  }

  ocorrenciaSelect.addEventListener('change', toggleAlunoCheckboxes);
  toggleAlunoCheckboxes();
</script>

{% endblock %}
